<!DOCTYPE html>
<!-- ADMIN DASHBOARD NFC PAYMENT -->
<!-- Dashboard untuk monitor dan kontrol sistem pembayaran NFC -->
<html lang="id">
<head>
    <!-- Set encoding UTF-8 agar karakter Indonesia tampil benar -->
    <meta charset="UTF-8">
    <!-- Agar responsive di HP dan tablet -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Judul tab browser -->
    <title>Admin NFC Payment</title>
</head>
<body>
    <!-- BAGIAN HEADER: Judul dan info dashboard -->
    <div class="header">
        <h1>üîí Admin NFC Payment - Control Center</h1>
        <p>Monitor semua pergerakan & ambil tindakan real-time - Full Control Dashboard</p>
        <div style="margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 4px; font-size: 13px;">
            ‚ÑπÔ∏è Dashboard ini untuk monitoring real-time semua aktivitas NFC Payment | Auto-refresh setiap 30 detik
        </div>
    </div>

    <!-- CONTAINER UTAMA: Wadah semua section dashboard -->
    <div class="container">
        <!-- SECTION 1: LOG AKTIVITAS REAL-TIME -->
        <!-- Mencatat semua kejadian di sistem (transaksi, login, fraud, dll) -->
        <div class="section" style="border-left: 4px solid #9b59b6; background-color: #f4ecf7;">
            <div class="section-header" style="color: #8e44ad; display: flex; justify-content: space-between; align-items: center;">
                <span>üìä Real-time Activity Log - Semua Pergerakan</span>
                <button class="btn btn-sm" onclick="clearActivityLog()" style="background: #e74c3c; color: white; padding: 5px 15px;">Clear Log</button>
            </div>
            <div class="section-content">
                <div style="padding: 10px; background: #e8f5e9; border-radius: 4px; margin-bottom: 10px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Log ini menampilkan semua aktivitas yang terjadi di sistem secara real-time. 
                    Setiap transaksi, login user, fraud detection, dan perubahan data akan tercatat di sini dengan timestamp.
                    Berguna untuk audit trail dan monitoring sistem.
                </div>
                <div id="activityLog" style="max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 4px;">
                    <div style="color: #2ecc71;">‚úÖ Dashboard initialized - Waiting for activities...</div>
                </div>
            </div>
        </div>

        <!-- SECTION 2: TOMBOL AKSI CEPAT -->
        <!-- Tombol untuk block user, reset saldo, top-up, dll -->
        <div class="section" style="border-left: 4px solid #3498db;">
            <div class="section-header" style="color: #2980b9;">‚ö° Quick Actions - Kontrol Cepat</div>
            <div class="section-content">
                <div style="padding: 10px; background: #e3f2fd; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Tombol-tombol aksi cepat untuk mengelola sistem:
                    <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                        <li><strong>Block User:</strong> Blokir user yang mencurigakan dari sistem</li>
                        <li><strong>Unblock User:</strong> Kembalikan user yang diblokir agar bisa transaksi lagi</li>
                        <li><strong>Reset Balance:</strong> Ubah saldo user tertentu (untuk koreksi)</li>
                        <li><strong>Bulk Top-up:</strong> Top-up saldo ke semua user sekaligus</li>
                        <li><strong>Clear Fraud Alerts:</strong> Hapus history fraud detection</li>
                        <li><strong>Refresh All Data:</strong> Update semua data dari backend</li>
                    </ul>
                </div>
                <!-- Grid layout untuk tombol-tombol aksi -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <!-- Tombol Block User: Blokir user mencurigakan -->
                    <button class="action-btn" onclick="showBlockUserModal()" style="background: #e74c3c;">
                        üö´ Block User/Transaction
                    </button>
                    <!-- Tombol Unblock User: Kembalikan user yang diblokir -->
                    <button class="action-btn" onclick="showUnblockUserModal()" style="background: #27ae60;">
                        ‚úÖ Unblock User
                    </button>
                    <!-- Tombol Reset Balance: Koreksi saldo user -->
                    <button class="action-btn" onclick="showResetBalanceModal()" style="background: #f39c12;">
                        üí∞ Reset User Balance
                    </button>
                    <!-- Tombol Bulk Top-up: Top-up semua user sekaligus -->
                    <button class="action-btn" onclick="showBulkTopupModal()" style="background: #27ae60;">
                        üíµ Bulk Top-up All Users
                    </button>
                    <!-- Tombol Clear Fraud: Hapus history fraud detection -->
                    <button class="action-btn" onclick="clearAllFraudAlerts()" style="background: #95a5a6;">
                        üóëÔ∏è Clear Fraud Alerts
                    </button>
                    <!-- Tombol Refresh: Update semua data manual -->
                    <button class="action-btn" onclick="refreshAllData()" style="background: #16a085;">
                        üîÑ Refresh All Data
                    </button>
                </div>
            </div>
        </div>

        <!-- 
            ====================================================================
            SECTION 3: DASHBOARD CONTROLS
            ====================================================================
            Fungsi:
            Kontrol untuk update/refresh data dashboard.
            
            2 Mekanisme Refresh:
            
            1. Manual Refresh (üîÑ Refresh Data Manual)
               - Update data on-demand (instant)
               - Memanggil loadDevices(), loadFraudAlerts(), 
                 loadAllTransactions(), loadAllUsers()
               - Berguna saat memerlukan data terbaru segera
               - No waiting untuk auto-refresh timer
               
            2. Auto Refresh Toggle (Auto Refresh: OFF/ON)
               - Toggle automatic refresh setiap 30 detik
               - ON: setInterval() calls refresh functions
               - OFF: clearInterval() stops automatic updates
               - State saved di variable autoRefresh (boolean)
               - Interval ID saved di refreshInterval
               
            Implementation Detail:
            - toggleAutoRefresh() function untuk switch ON/OFF
            - Button color change: blue (OFF) -> green (ON)
            - Button text update untuk show current state
            - Cleanup interval on page unload/component unmount
            
            Best Practice:
            - Auto-refresh OFF saat editing data (prevent conflicts)
            - Auto-refresh ON untuk continuous monitoring
            - Manual refresh untuk immediate update needs
            
            Performance Consideration:
            - 30s interval balance antara freshness dan server load
            - Dapat dikonfigurasi di backend (environment variable)
            - Consider WebSocket untuk true real-time (future enhancement)
            ====================================================================
        -->
        <div style="padding: 15px; background: #e8f5e9; border-left: 4px solid #4CAF50; border-radius: 4px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 10px 0; color: #2e7d32;">‚öôÔ∏è Dashboard Controls</h3>
            <p style="margin: 0 0 15px 0; font-size: 14px; color: #2e7d32;">
                <strong>Penjelasan:</strong> Kontrol untuk refresh data. <strong>Auto Refresh ON</strong> akan update data otomatis setiap 30 detik.
                Gunakan <strong>Refresh Data</strong> untuk update manual kapan saja.
            </p>
            <div class="controls">
                <button class="btn btn-success" onclick="refreshData()">üîÑ Refresh Data Manual</button>
                <button class="btn btn-success" onclick="toggleAutoRefresh()" id="autoRefreshBtn">Auto Refresh: ON</button>
            </div>
        </div>

        <!-- 
            ====================================================================
            SECTION 4: STATISTICS OVERVIEW - SYSTEM METRICS
            ====================================================================
            Fungsi:
            Menampilkan 4 key metrics untuk overview kesehatan sistem.
            Data dihitung dari aggregasi semua devices yang terkoneksi.
            
            4 Metrics:
            
            1. Total Devices (üì± - Blue Border #2196F3)
               - Jumlah smartphone Android yang terdaftar
               - Perhitungan: devices.length
               - Setiap device = unique deviceId
               - Indicator: Pertumbuhan user base
               
            2. Total Users (üë• - Green Border #4CAF50)
               - Total akun pengguna di seluruh devices
               - Perhitungan: devices.reduce((sum, device) => 
                             sum + (device.totalUsers || 0), 0)
               - User bisa multi-device (sync via backend)
               - Indicator: Active user count
               
            3. Total Balance (üí∞ - Orange Border #FF9800)
               - Saldo total di sistem (Rupiah)
               - Perhitungan: devices.reduce((sum, device) => 
                             sum + (device.totalBalance || 0), 0)
               - Representasi "uang beredar" dalam ekosistem
               - Format: formatCurrency() untuk IDR formatting
               - Indicator: Financial health
               
            4. Online Devices (‚úÖ - Purple Border #9C27B0)
               - Devices yang sync dalam 5 menit terakhir
               - Perhitungan: devices.filter(device => 
                             isDeviceOnline(device.lastSync)).length
               - isDeviceOnline: (now - lastSync) <= 5 minutes
               - Indicator: System availability dan connectivity
               
            Update Mechanism:
            - Function updateStats() dipanggil setelah loadDevices()
            - Real-time calculation dari live data
            - Auto-update saat refresh (manual/auto 30s)
            
            UI Design:
            - Grid layout responsive (4 columns desktop, stack mobile)
            - Each card: number + label + description
            - Color-coded border untuk visual distinction
            - Hover effect: lift dan shadow untuk interactivity
            - Font size hierarchy: 28px number, 14px label, 11px desc
            
            Business Logic:
            - Devices.length -> Infrastructure scale
            - TotalUsers -> User adoption
            - TotalBalance -> Transaction volume/liquidity
            - OnlineDevices -> System health/uptime
            
            Use Case:
            - Executive dashboard untuk quick insights
            - System health monitoring
            - Growth tracking (compare over time)
            - Capacity planning (devices vs users ratio)
            ====================================================================
        -->
        <div style="margin-bottom: 15px; padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
            <h3 style="margin: 0 0 10px 0; color: #856404;">üìà Statistik Sistem - Overview Keseluruhan</h3>
            <p style="margin: 0; font-size: 14px; color: #856404;">
                <strong>Penjelasan:</strong> Statistik ini menampilkan ringkasan sistem secara keseluruhan.
                Data diambil dari semua device yang terkoneksi dan diupdate setiap refresh.
            </p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card" style="border-left: 4px solid #2196F3;">
                <div class="stat-number" id="totalDevices">0</div>
                <div class="stat-label">Total Devices</div>
                <small style="color: #7f8c8d; font-size: 11px;">Jumlah HP yang terdaftar</small>
            </div>
            <div class="stat-card" style="border-left: 4px solid #4CAF50;">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
                <small style="color: #7f8c8d; font-size: 11px;">Total akun pengguna</small>
            </div>
            <div class="stat-card" style="border-left: 4px solid #FF9800;">
                <div class="stat-number" id="totalBalance">Rp 0</div>
                <div class="stat-label">Total Balance</div>
                <small style="color: #7f8c8d; font-size: 11px;">Saldo keseluruhan sistem</small>
            </div>
            <div class="stat-card" style="border-left: 4px solid #9C27B0;">
                <div class="stat-number" id="onlineDevices">0</div>
                <div class="stat-label">Online Devices</div>
                <small style="color: #7f8c8d; font-size: 11px;">Device aktif saat ini</small>
            </div>
        </div>

        <!-- 
            ====================================================================
            SECTION 5: AI FRAUD DETECTION STATISTICS
            ====================================================================
            Fungsi:
            Menampilkan metrics dari sistem AI Fraud Detection untuk monitoring
            keamanan transaksi secara real-time.
            
            AI Algorithm Overview:
            Sistem menggunakan 2 algoritma machine learning untuk scoring:
            
            1. VELOCITY DETECTION (Weight: 70%)
               - Analisis kecepatan transaksi berturut-turut
               - Pattern: User normal = 1-2 transaksi per menit
               - Suspicious: >3 transaksi dalam 1 menit
               - Formula: velocityRisk = (txCount / timeWindow) * weight
               - Detection: Rapid-fire transactions (bot/automation)
               
            2. AMOUNT ANALYSIS (Weight: 30%)
               - Analisis jumlah transaksi vs historical pattern
               - Baseline: Average transaction amount per user
               - Anomaly: >3x std deviation dari mean
               - Formula: amountRisk = |current - mean| / stdDev * weight
               - Detection: Unusual large/small amounts
            
            Risk Scoring Formula:
            riskScore = (velocityRisk * 0.7) + (amountRisk * 0.3)
            Output: 0-100 (percentage)
            
            Decision Logic:
            - riskScore < 40%: ALLOW (green) - Transaksi aman, proses normal
            - riskScore 40-60%: REVIEW (orange) - Flagged untuk manual review
            - riskScore > 60%: BLOCK (red) - Auto-reject, tidak diproses
            
            4 Fraud Metrics:
            
            1. Total Fraud Alerts (üö® - Pink #ff6b6b)
               - Count semua transaksi yang terdeteksi mencurigakan
               - Include: REVIEW + BLOCK
               - Source: fraudAlerts.length
               - Update: Real-time saat fraud terdeteksi
               
            2. Blocked Transactions (üö´ - Red #e74c3c)
               - Transaksi yang auto-rejected oleh AI (>60%)
               - Tidak diproses oleh sistem
               - Critical metric untuk security effectiveness
               - Formula: fraudStats.blockedTransactions
               
            3. Review Transactions (‚ö†Ô∏è - Orange #f39c12)
               - Transaksi flagged untuk manual review (40-60%)
               - Memerlukan admin decision: allow/block
               - Queue untuk admin investigation
               - Formula: fraudStats.reviewTransactions
               
            4. Last Fraud Alert (üïê - Green #27ae60)
               - Timestamp fraud terakhir terdeteksi
               - Format: Relative time ("5m ago", "2h ago", "Never")
               - Indicator: Frequency of fraud attempts
               - Function: formatRelativeTime(lastAlert)
            
            Data Flow:
            1. Transaction occurs on Android device
            2. Fraud detection runs (fraudDetection.ts)
            3. Risk score calculated (0-100)
            4. Decision made (ALLOW/REVIEW/BLOCK)
            5. Alert sent to admin server (if REVIEW or BLOCK)
            6. Dashboard displays in Fraud Alerts section
            7. Statistics updated (counters increment)
            
            Algorithm Weights Rationale:
            - Velocity (70%): Primary indicator of automation/bot
            - Amount (30%): Secondary indicator of fraud patterns
            - Combined: Comprehensive risk assessment
            
            Machine Learning Approach:
            - Supervised learning: Trained on historical fraud cases
            - Feature engineering: Velocity, amount, time, device patterns
            - Real-time inference: <100ms decision time
            - Adaptive learning: Updates baseline per user behavior
            
            False Positive Handling:
            - REVIEW queue untuk human verification
            - Admin dapat override AI decision
            - Feedback loop untuk algorithm improvement
            - Balance: Security vs User Experience
            
            Performance Metrics:
            - Precision: % of flagged fraud yang benar fraud
            - Recall: % of actual fraud yang terdeteksi
            - F1 Score: Harmonic mean of precision & recall
            - Target: >90% precision, >85% recall
            
            Use Case:
            - Real-time fraud prevention
            - Security monitoring dashboard
            - Trend analysis (fraud attempts over time)
            - Algorithm effectiveness evaluation
            ====================================================================
        -->
        <div style="margin-bottom: 15px; padding: 15px; background: #ffebee; border-left: 4px solid #e74c3c; border-radius: 4px;">
            <h3 style="margin: 0 0 10px 0; color: #c0392b;">ü§ñ Statistik AI Fraud Detection</h3>
            <p style="margin: 0; font-size: 14px; color: #c0392b;">
                <strong>Penjelasan:</strong> Sistem AI menganalisis setiap transaksi dengan 2 algoritma:
                <strong>Velocity Detection (70%)</strong> untuk deteksi transaksi cepat berturut-turut, dan
                <strong>Amount Analysis (30%)</strong> untuk jumlah tidak normal. 
                Risk score 0-100 menentukan status: ALLOW (&lt;40), REVIEW (40-60), atau BLOCK (&gt;60).
            </p>
        </div>
        
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card" style="border-left: 4px solid #ff6b6b;">
                <div class="stat-number" id="totalFraudAlerts" style="color: #e74c3c;">0</div>
                <div class="stat-label">Fraud Alerts</div>
                <small style="color: #7f8c8d; font-size: 11px;">Total alert terdeteksi</small>
            </div>
            <div class="stat-card" style="border-left: 4px solid #e74c3c;">
                <div class="stat-number" id="blockedTransactions" style="color: #c0392b;">0</div>
                <div class="stat-label">Blocked Transactions</div>
                <small style="color: #7f8c8d; font-size: 11px;">Transaksi ditolak AI (>60%)</small>
            </div>
            <div class="stat-card" style="border-left: 4px solid #f39c12;">
                <div class="stat-number" id="reviewTransactions" style="color: #e67e22;">0</div>
                <div class="stat-label">Review Transactions</div>
                <small style="color: #7f8c8d; font-size: 11px;">Perlu review manual (40-60%)</small>
            </div>
            <div class="stat-card" style="border-left: 4px solid #27ae60;">
                <div class="stat-number" id="lastFraudAlert" style="color: #2ecc71; font-size: 16px;">Never</div>
                <div class="stat-label">Last Fraud Alert</div>
                <small style="color: #7f8c8d; font-size: 11px;">Alert terakhir diterima</small>
            </div>
        </div>

        <!-- 
            ====================================================================
            SECTION 6: FRAUD DETECTION AI - REAL-TIME ALERTS
            ====================================================================
            Fungsi:
            Menampilkan detail fraud alerts secara real-time dengan informasi
            lengkap untuk investigasi dan decision making.
            
            Alert Display:
            Setiap alert card menampilkan:
            
            1. Header Information:
               - Device Name/ID: Identifier device yang melakukan transaksi
               - Risk Level Badge: Color-coded (LOW/MEDIUM/HIGH/CRITICAL)
               - Decision Badge: AI decision (ALLOW/REVIEW/BLOCK)
               - Risk Score: Percentage 0-100% dengan color gradient
               - Confidence: AI confidence level dalam decision (0-100%)
               
            2. Transaction Details:
               - Transaction ID: Unique identifier untuk tracing
               - IP Address: Network location (untuk geo-analysis)
               - User Information: Sender dan receiver IDs
               - Amount: Jumlah transaksi (Rupiah)
               - Timestamp: Waktu terdeteksi (absolute + relative)
               
            3. Risk Factors (Alasan Fraud):
               Bullet list penjelasan mengapa transaksi flagged:
               - "Velocity too high: 5 transactions in 2 minutes"
               - "Amount abnormal: 3.2x average transaction"
               - "Unusual time: Transaction at 3 AM"
               - "New device: First transaction from this device"
               - "Geo-anomaly: IP from different country"
               
            4. AI Analysis Breakdown:
               Detail risk per kategori (0-100%):
               - velocityRisk: Kecepatan transaksi risk
               - amountRisk: Jumlah abnormal risk
               - timeRisk: Waktu mencurigakan risk (malam/unusual)
               - deviceRisk: Device pattern anomaly risk
               - geoRisk: Location anomaly risk (optional)
               
               Visual: "Velocity: 85%, Amount: 45%, Time: 20%, Device: 10%"
               
            Risk Level Categories:
            
            üü¢ LOW (0-39% - Green #27ae60):
               - Transaksi normal dalam behavioral pattern
               - Decision: AUTO ALLOW
               - Action: No admin intervention needed
               - Display: Tidak ditampilkan di alerts (noise reduction)
               
            üü° MEDIUM (40-59% - Orange #f39c12):
               - Transaksi sedikit mencurigakan
               - Decision: REVIEW REQUIRED
               - Action: Admin manual check
               - Priority: Medium queue
               - Typical: First-time large transaction, new device
               
            üü† HIGH (60-79% - Red #e74c3c):
               - Transaksi sangat mencurigakan
               - Decision: AUTO BLOCK (default) atau REVIEW
               - Action: Immediate admin attention
               - Priority: High queue
               - Typical: Rapid transactions, geo-anomaly
               
            üî¥ CRITICAL (80-100% - Dark Red #c0392b):
               - Transaksi hampir pasti fraud
               - Decision: IMMEDIATE BLOCK
               - Action: Urgent investigation + potential ban
               - Priority: Critical queue
               - Typical: Bot automation, stolen credentials
            
            Alert Rendering:
            - Function: renderFraudAlerts()
            - Data Source: fraudAlerts[] array
            - Sort: Descending by timestamp (newest first)
            - Limit: Display 10 most recent alerts
            - Auto-update: Setiap refresh (30s) atau manual
            
            Color Coding Logic:
            - Risk badges: Color = f(riskScore)
            - Decision badges: BLOCK=red, REVIEW=orange, ALLOW=green
            - Background: Subtle red tint untuk attention
            - Border: Solid red untuk critical visual cue
            
            Interaction:
            - Click alert untuk expand/collapse detail
            - Hover untuk highlight
            - Action buttons: "Investigate", "Allow", "Block Permanently"
            - Export: Individual alert atau batch
            
            Data Persistence:
            - Alerts stored in backend database (Prisma)
            - History maintained untuk trend analysis
            - Can be cleared via "Clear Fraud Alerts" action
            
            Real-time Update Mechanism:
            - WebSocket (future) atau Polling (current)
            - New alert: Auto-insert at top
            - Animation: Pulse effect untuk new alert
            - Sound notification (optional, dapat di-toggle)
            
            Investigation Workflow:
            1. Alert appears in dashboard
            2. Admin reviews risk factors
            3. Admin checks user history
            4. Decision: Allow (whitelist) atau Block (ban)
            5. Action logged untuk audit
            6. User notified (if blocked)
            
            False Positive Handling:
            - Admin dapat mark as "False Positive"
            - Feedback untuk ML algorithm improvement
            - Adjust threshold per use case
            - Whitelist trusted users/devices
            
            Use Case:
            - Real-time fraud monitoring
            - Security Operations Center (SOC) dashboard
            - Incident response dan investigation
            - Fraud pattern identification
            - ML algorithm effectiveness monitoring
            ====================================================================
        -->
        <div class="section" style="border-left: 4px solid #e74c3c;">
            <div class="section-header" style="color: #c0392b;">
                ü§ñ Fraud Detection AI - Real-time Monitoring
            </div>
            <div class="section-content">
                <div style="padding: 10px; background: #ffebee; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Section ini menampilkan alert dari sistem AI Fraud Detection secara real-time.
                    Setiap transaksi dianalisis dengan algoritma machine learning dan jika terdeteksi mencurigakan, akan muncul di sini.
                    Alert menampilkan: <strong>Risk Score</strong> (0-100%), <strong>Risk Level</strong> (LOW/MEDIUM/HIGH/CRITICAL), 
                    <strong>Decision</strong> (ALLOW/REVIEW/BLOCK), dan <strong>Alasan</strong> mengapa ditandai sebagai fraud.
                    <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">
                        <strong>Kategori Risk Level:</strong><br>
                        ‚Ä¢ <span style="color: #27ae60;">LOW (0-39%)</span> - Transaksi normal, aman<br>
                        ‚Ä¢ <span style="color: #f39c12;">MEDIUM (40-59%)</span> - Perlu perhatian<br>
                        ‚Ä¢ <span style="color: #e74c3c;">HIGH (60-79%)</span> - Mencurigakan<br>
                        ‚Ä¢ <span style="color: #c0392b;">CRITICAL (80-100%)</span> - Sangat berbahaya
                    </div>
                </div>
                <div id="fraudAlertsContainer">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">No fraud alerts detected</p>
                </div>
            </div>
        </div>

        <!-- Transaction Monitoring Section (Full Control) -->
        <div class="section" style="border-left: 4px solid #3498db;">
            <div class="section-header" style="color: #2980b9;">
                üí≥ Transaction Monitoring - Full Control (Seperti Prisma Studio)
            </div>
            <div class="section-content">
                <div style="padding: 10px; background: #e3f2fd; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Tabel monitoring semua transaksi seperti Prisma Studio. 
                    Anda dapat melihat detail setiap transaksi: ID, pengirim, penerima, jumlah, risk score dari AI, 
                    dan alasan jika transaksi ditandai fraud. Filter tersedia untuk melihat transaksi berdasarkan 
                    risk level (CRITICAL/HIGH/MEDIUM/LOW) dan status (completed/pending/failed).
                    Gunakan search untuk mencari transaksi user tertentu.
                </div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <button class="btn btn-primary" onclick="loadAllTransactions()">üîÑ Refresh</button>
                    <select id="riskFilter" onchange="filterTransactionsByRisk()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="ALL">All Risk Levels</option>
                        <option value="CRITICAL">CRITICAL Only</option>
                        <option value="HIGH">HIGH Only</option>
                        <option value="MEDIUM">MEDIUM Only</option>
                        <option value="LOW">LOW Only</option>
                    </select>
                    <select id="statusFilter" onchange="filterTransactionsByRisk()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="ALL">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="pending">Pending</option>
                        <option value="failed">Failed</option>
                    </select>
                    <input type="number" id="limitInput" placeholder="Limit" value="50" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 100px;">
                    <input type="text" id="searchUser" placeholder="Cari username..." onkeyup="filterTransactionsByRisk()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 200px;">
                    <button class="btn btn-success" onclick="showAddTransactionModal()" style="margin-left: auto;">
                        ‚ûï Add Transaction Manual
                    </button>
                </div>
                <div id="transactionsContainer">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading transactions...</p>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="section" style="border-left: 4px solid #e67e22;">
            <div class="section-header" style="color: #d35400; display: flex; justify-content: space-between; align-items: center;">
                <span>üë• User Management - Kelola Semua User</span>
                <button class="btn btn-success" onclick="showAddUserModal()">‚ûï Add New User</button>
            </div>
            <div class="section-content">
                <div style="padding: 10px; background: #fff3e0; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Section ini untuk mengelola semua user yang terdaftar di sistem.
                    Anda dapat melihat daftar lengkap user dengan informasi: ID, username, nama lengkap, balance, 
                    dan device yang digunakan. Fitur yang tersedia:
                    <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                        <li><strong>Add New User:</strong> Buat akun user baru manual</li>
                        <li><strong>Edit User:</strong> Ubah balance user (koreksi saldo)</li>
                        <li><strong>Delete User:</strong> Hapus user dan semua transaksinya</li>
                        <li><strong>Search:</strong> Cari user berdasarkan username atau nama</li>
                    </ul>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="searchUserList" placeholder="Cari user..." onkeyup="filterUserList()" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 300px;">
                </div>
                <div id="userListContainer">
                    <p style="text-align: center; color: #7f8c8d; padding: 20px;">Loading users...</p>
                </div>
            </div>
        </div>

        <!-- Devices Section -->
        <div class="section" style="border-left: 4px solid #9C27B0;">
            <div class="section-header" style="color: #7B1FA2;">
                üì± Active Users - User Management
            </div>
            <div class="section-content">
                <div style="padding: 10px; background: #f3e5f5; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Menampilkan semua device (smartphone Android) yang terhubung ke admin server.
                    Setiap device menunjukkan:
                    <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                        <li><strong>Device ID:</strong> Identifier unik device</li>
                        <li><strong>Status:</strong> Online (sync &lt;5 menit) atau Offline</li>
                        <li><strong>Total User:</strong> Jumlah akun yang terdaftar di device tersebut</li>
                        <li><strong>Total Saldo:</strong> Total balance semua user di device</li>
                        <li><strong>Transaksi:</strong> Jumlah transaksi yang dilakukan</li>
                        <li><strong>Sync Terakhir:</strong> Waktu terakhir device kirim data ke admin</li>
                        <li><strong>Tambah Saldo:</strong> Admin dapat top-up saldo ke device (butuh password)</li>
                    </ul>
                </div>
                <div id="devicesList" class="device-grid">
                    <div class="no-data">No devices found. Make sure apps are running and connected.</div>
                </div>
            </div>
        </div>

        <!-- NFC CARD MANAGEMENT SECTION -->
        <div class="section" style="border-left: 4px solid #e91e63;">
            <div class="section-header" style="color: #c2185b; display: flex; justify-content: space-between; align-items: center;">
                <span>üé¥ NFC Card Management - Kelola Kartu Fisik</span>
                <button class="btn btn-sm" onclick="showRegisterCardModal()" style="background: #e91e63; color: white; padding: 8px 20px;">
                    ‚ûï Register Kartu Baru
                </button>
            </div>
            <div class="section-content">
                <div style="padding: 10px; background: #fce4ec; border-radius: 4px; margin-bottom: 15px; font-size: 13px;">
                    <strong>üí° Penjelasan:</strong> Kelola kartu NFC fisik (NTag215 13.56MHz) yang terdaftar di sistem.
                    <ul style="margin: 8px 0 0 20px; line-height: 1.8;">
                        <li><strong>Register Kartu:</strong> Daftarkan kartu NFC baru dengan UID unik</li>
                        <li><strong>Link ke User:</strong> Hubungkan kartu dengan akun pengguna</li>
                        <li><strong>Top-up Saldo:</strong> Isi saldo kartu (memerlukan password admin)</li>
                        <li><strong>Block/Unblock:</strong> Blokir atau aktifkan kembali kartu</li>
                        <li><strong>Status:</strong> ACTIVE (hijau), BLOCKED (merah), LOST (abu-abu), EXPIRED (kuning)</li>
                        <li><strong>History:</strong> Lihat riwayat transaksi per kartu</li>
                    </ul>
                </div>

                <!-- Filter dan Search -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="cardSearchInput" placeholder="üîç Cari Card ID atau User..." 
                           style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                           onkeyup="filterCards()">
                    <select id="cardStatusFilter" onchange="filterCards()" 
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">üìä Semua Status</option>
                        <option value="ACTIVE">‚úÖ ACTIVE</option>
                        <option value="BLOCKED">üö´ BLOCKED</option>
                        <option value="LOST">‚ùå LOST</option>
                        <option value="EXPIRED">‚ö†Ô∏è EXPIRED</option>
                    </select>
                    <select id="cardLinkFilter" onchange="filterCards()"
                            style="padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">üë§ Semua Kartu</option>
                        <option value="linked">üîó Linked (dengan user)</option>
                        <option value="unlinked">‚≠ï Unlinked (belum link)</option>
                    </select>
                    <button class="btn" onclick="refreshCards()" style="background: #16a085; color: white;">
                        üîÑ Refresh
                    </button>
                </div>

                <!-- Cards List -->
                <div id="nfcCardsList" class="device-grid">
                    <div class="no-data">Loading NFC cards...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let devices = [];
        let fraudAlerts = [];
        let fraudStats = {};
        let allTransactions = [];
        let filteredTransactions = [];
        let allUsers = [];
        let activityLogEntries = [];
        let autoRefresh = true; // Auto refresh AKTIF by default untuk monitoring real-time
        let refreshInterval = null;
        let nfcCards = []; // Array untuk menyimpan data kartu NFC
        let filteredNfcCards = []; // Array untuk hasil filter

        // =================================================================
        // ACTIVITY LOG - Monitor semua pergerakan
        // =================================================================
        function logActivity(type, message, color = '#2ecc71') {
            const timestamp = new Date().toLocaleTimeString('id-ID');
            const entry = {
                type,
                message,
                timestamp: new Date(),
                color
            };
            
            activityLogEntries.unshift(entry);
            if (activityLogEntries.length > 100) activityLogEntries.pop();
            
            const logContainer = document.getElementById('activityLog');
            const logLine = document.createElement('div');
            logLine.style.color = color;
            logLine.style.marginBottom = '5px';
            
            const icons = {
                'transaction': 'üí≥',
                'user': 'üë§',
                'fraud': 'üö®',
                'device': 'üì±',
                'action': '‚ö°',
                'system': '‚öôÔ∏è',
                'error': '‚ùå'
            };
            
            logLine.innerHTML = `[${timestamp}] ${icons[type] || 'üìä'} ${message}`;
            logContainer.insertBefore(logLine, logContainer.firstChild);
            
            // Auto-scroll to top
            logContainer.scrollTop = 0;
            
            // Keep only 50 visible entries
            while (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        function clearActivityLog() {
            if (confirm('Clear semua activity log?')) {
                document.getElementById('activityLog').innerHTML = 
                    '<div style="color: #2ecc71;">‚úÖ Log cleared - Waiting for activities...</div>';
                activityLogEntries = [];
                logActivity('system', 'Activity log cleared', '#95a5a6');
            }
        }

        // =================================================================
        // ACTION FUNCTIONS - Quick Actions
        // =================================================================
        
        // Format currency
        function formatCurrency(amount) {
            return 'Rp ' + new Intl.NumberFormat('id-ID').format(amount);
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('id-ID');
        }

        // Cek apakah device online (sync dalam 5 menit terakhir)
        function isDeviceOnline(lastSync) {
            const now = new Date(); // Waktu sekarang
            const lastSyncDate = new Date(lastSync); // Waktu sync terakhir
            const diffMinutes = (now - lastSyncDate) / (1000 * 60); // Selisih dalam menit
            return diffMinutes <= 5; // Online jika <= 5 menit
        }

        // Load data semua device dari backend
        async function loadDevices() {
            try {
                const response = await fetch('/api/devices'); // Ambil data dari API
                if (response.ok) { // Jika sukses
                    const newDevices = await response.json(); // Parse JSON response
                    
                    // Deteksi HP baru terkoneksi
                    if (newDevices.length > devices.length) {
                        const newCount = newDevices.length - devices.length;
                        logActivity('connection', `üì± ${newCount} HP baru terkoneksi ke sistem!`, '#3498db');
                    }
                    
                    devices = newDevices; // Update devices array
                    updateStats(); // Update statistik dashboard
                    renderDevices(); // Render daftar device
                    
                    // Log status koneksi
                    const onlineCount = devices.filter(device => isDeviceOnline(device.lastSync)).length;
                    if (onlineCount > 0) {
                        logActivity('status', `üì± ${onlineCount}/${devices.length} HP online`, '#27ae60');
                    }
                    
                } else {
                    console.error('Failed to load devices:', response.statusText);
                    logActivity('error', 'Gagal load data device', '#e74c3c');
                }
            } catch (error) {
                console.error('Error loading devices:', error);
                logActivity('error', `Error loading devices: ${error.message}`, '#e74c3c');
            }
        }

        // Fungsi update statistik dashboard (total devices, users, balance, online)
        function updateStats() {
            const totalDevices = devices.length; // Hitung jumlah device
            
            // UPDATE: Gunakan allUsers array untuk hitung statistik yang akurat
            const totalUsers = allUsers.length; // Hitung dari allUsers yang sudah diload
            
            // Hitung total saldo dari allUsers
            const totalBalance = allUsers.reduce((sum, user) => sum + (parseInt(user.balance) || 0), 0);
            
            // Hitung device yang online - gunakan field isOnline dari backend
            const onlineDevices = devices.filter(device => device.isOnline === true).length;

            // Update angka di dashboard
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('totalBalance').textContent = formatCurrency(totalBalance);
            document.getElementById('onlineDevices').textContent = onlineDevices;
            
            // Log untuk debugging
            console.log(`üìä Stats updated: Devices ${totalDevices}, Online ${onlineDevices}, Users ${totalUsers}, Balance ${formatCurrency(totalBalance)}`);
            
            // Log device status for debugging
            devices.forEach(device => {
                console.log(`üì± Device ${device.deviceId}: Online = ${device.isOnline}, LastSeen = ${device.lastSeen}`);
            });
        }

        // Fungsi render tampilan daftar device
        function renderDevices() {
            const devicesList = document.getElementById('devicesList'); // Ambil element devices

            // Jika tidak ada device, tampilkan pesan kosong
            if (devices.length === 0) {
                devicesList.innerHTML = '<div class="no-data">No devices found. Make sure apps are running and connected.</div>';
                return;
            }

            // Loop semua device dan buat HTML untuk ditampilkan
            devicesList.innerHTML = devices.map(device => {
                // Gunakan field isOnline dari backend langsung
                const isOnline = device.isOnline === true; 
                const statusClass = isOnline ? 'status-online' : 'status-offline'; // CSS class
                const statusText = isOnline ? 'Online' : 'Offline'; // Text status

                // Return HTML untuk 1 device
                return `
                    <div class="device-item">
                        <div class="device-header">
                            <div class="device-id">${device.deviceId}</div>
                            <div class="device-status ${statusClass}">${statusText}</div>
                        </div>

                        <div class="device-info">
                            <div class="info-item">
                                <div class="info-label">Total User</div>
                                <div class="info-value">${device.totalUsers || 0}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Total Saldo</div>
                                <div class="info-value">${formatCurrency(device.totalBalance || 0)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Transaksi</div>
                                <div class="info-value">${device.totalTransactions || 0}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Sync Terakhir</div>
                                <div class="info-value">${formatDate(device.lastSeen || device.lastSync)}</div>
                            </div>
                        </div>

                        <div class="balance-form">
                            <!-- Input untuk jumlah top-up -->
                            <input type="number" 
                                   class="balance-input" 
                                   placeholder="Jumlah saldo" 
                                   id="balance-${device.deviceId}">
                            <!-- Tombol untuk top-up saldo -->
                            <button class="btn btn-primary" 
                                    onclick="updateBalance('${device.deviceId}')">
                                Tambah Saldo
                            </button>
                            <!-- Tombol untuk hapus user -->
                            <button class="btn btn-danger" 
                                    onclick="deleteDevice('${device.deviceId}')" 
                                    style="margin-left: 10px;">
                                üóëÔ∏è Hapus User
                            </button>
                        </div>
                    </div>
                `;
            }).join(''); // Gabungkan semua HTML device jadi satu string
        }

        // Fungsi update balance (top-up saldo) untuk user tertentu
        async function updateBalance(deviceId) {
            const input = document.getElementById(`balance-${deviceId}`); // Ambil input saldo
            const amount = parseFloat(input.value); // Parse nilai input jadi angka

            // Validasi input tidak boleh kosong atau negatif
            if (!amount || amount <= 0) {
                alert('‚ùå Masukkan jumlah saldo yang valid (lebih dari 0)');
                return;
            }

            // Validasi maksimal top-up Rp 500.000
            if (amount > 500000) {
                alert('‚ùå Maksimal top-up adalah Rp 500,000 per transaksi');
                return;
            }

            // Minta password admin untuk keamanan
            const adminPassword = prompt('üîí Password Admin:');
            if (!adminPassword) { // Jika password tidak diisi
                alert('‚ùå Password admin diperlukan!');
                return;
            }

            try {
                // Extract user ID dari deviceId (format: user_4)
                const userId = deviceId.startsWith('user_') ? deviceId.replace('user_', '') : deviceId;
                
                // Kirim request PUT ke endpoint users (bukan update-balance)
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        balance: amount // Set balance baru (bukan increment)
                    })
                });

                if (response.ok) { // Jika sukses
                    const result = await response.json();
                    input.value = ''; // Kosongkan input
                    alert(`‚úÖ Berhasil update saldo ${formatCurrency(amount)} untuk user ${userId}`);
                    await loadDevices(); // Refresh data user
                } else if (response.status === 401) { // Jika password salah
                    alert('‚ùå Password admin salah! Akses ditolak.');
                } else if (response.status === 404) { // Jika user tidak ditemukan
                    alert('‚ùå User tidak ditemukan!');
                } else { // Error lainnya
                    const error = await response.json();
                    alert('‚ùå Gagal mengupdate saldo: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating balance:', error);
                alert('‚ùå Terjadi kesalahan saat mengupdate saldo');
            }
        }

        // Fungsi untuk hapus user (bukan device)
        async function deleteDevice(deviceId) {
            if (!confirm(`‚ö†Ô∏è Apakah Anda yakin ingin menghapus user ${deviceId}?`)) {
                return; // Batal jika user tidak konfirmasi
            }
            
            // Minta password admin untuk keamanan
            const adminPassword = prompt('üîí Password Admin:');
            if (!adminPassword) {
                alert('‚ùå Password admin diperlukan!');
                return;
            }
            
            try {
                const response = await fetch(`/api/delete-device/${deviceId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        adminPassword: adminPassword
                    })
                });
                
                if (response.ok) {
                    alert(`‚úÖ User ${deviceId} berhasil dihapus!`);
                    await loadDevices(); // Refresh data
                } else if (response.status === 401) {
                    alert('‚ùå Password admin salah! Akses ditolak.');
                } else {
                    const error = await response.json();
                    alert('‚ùå Gagal menghapus user: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('‚ùå Terjadi kesalahan saat menghapus user');
            }
        }

        // Toggle auto refresh ON/OFF
        function toggleAutoRefresh() {
            autoRefresh = !autoRefresh; // Balik status (ON jadi OFF, OFF jadi ON)
            const btn = document.getElementById('autoRefreshBtn'); // Ambil tombol

            if (autoRefresh) { // Jika auto-refresh aktif
                btn.textContent = 'Auto Refresh: ON';
                btn.className = 'btn btn-success'; // Tombol hijau
                // Set interval refresh tiap 30 detik
                autoRefreshInterval = setInterval(() => {
                    loadDevices(); // Refresh data device
                    loadFraudAlerts(); // Refresh data fraud
                }, 30000);
            } else { // Jika auto-refresh tidak aktif
                btn.textContent = 'Auto Refresh: OFF';
                btn.className = 'btn btn-primary'; // Tombol biru
                if (autoRefreshInterval) { // Hapus interval
                    clearInterval(autoRefreshInterval);
                }
            }
        }

        // Refresh data manual (tombol refresh)
        function refreshData() {
            loadDevices(); // Refresh device
            loadFraudAlerts(); // Refresh fraud alerts
            loadAllUsers(); // Refresh users langsung dari backend
            // updateStats() akan dipanggil otomatis setelah loadAllUsers() dan loadDevices()
        }

        // Load data fraud alerts dari backend
        async function loadFraudAlerts() {
            try {
                const response = await fetch('/api/fraud-alerts'); // Ambil data API
                if (response.ok) { // Jika sukses
                    const data = await response.json(); // Parse JSON
                    fraudAlerts = data.alerts || []; // Simpan alerts
                    fraudStats = data.stats || {}; // Simpan statistik
                    updateFraudStats(); // Update statistik di UI
                    renderFraudAlerts(); // Render daftar alerts
                } else {
                    console.error('Failed to load fraud alerts:', response.statusText);
                }
            } catch (error) {
                console.error('Error loading fraud alerts:', error);
            }
        }

        // Update statistik fraud (total alerts, blocked, review)
        function updateFraudStats() {
            document.getElementById('totalFraudAlerts').textContent = fraudStats.totalAlerts || 0;
            document.getElementById('blockedTransactions').textContent = fraudStats.blockedTransactions || 0;
            document.getElementById('reviewTransactions').textContent = fraudStats.reviewTransactions || 0;

            const lastAlert = fraudStats.lastAlert; // Waktu alert terakhir
            // Format waktu relatif (contoh: "5m ago", "2h ago")
            document.getElementById('lastFraudAlert').textContent = lastAlert ? formatRelativeTime(lastAlert) : 'Never';
        }

        // Format waktu relatif (contoh: 5m ago, 2h ago, 3d ago)
        function formatRelativeTime(dateString) {
            const now = new Date(); // Waktu sekarang
            const date = new Date(dateString); // Waktu target
            const diffMinutes = Math.floor((now - date) / (1000 * 60)); // Selisih dalam menit

            if (diffMinutes < 1) return 'Just now'; // Baru saja
            if (diffMinutes < 60) return `${diffMinutes}m ago`; // Dalam menit
            if (diffMinutes < 1440) return `${Math.floor(diffMinutes / 60)}h ago`; // Dalam jam
            return `${Math.floor(diffMinutes / 1440)}d ago`; // Dalam hari
        }

        // Render daftar fraud alerts
        function renderFraudAlerts() {
            const container = document.getElementById('fraudAlertsContainer'); // Ambil container

            // Jika tidak ada fraud alert
            if (fraudAlerts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #27ae60; padding: 20px;">‚úÖ No fraud alerts detected - System is secure</p>';
                return;
            }

            // Render max 10 alert teratas
            container.innerHTML = fraudAlerts.slice(0, 10).map(alert => {
                const riskClass = `risk-${alert.riskLevel.toLowerCase()}`; // CSS class risk (high/medium/low)
                const decisionClass = `decision-${alert.decision.toLowerCase()}`; // CSS class decision

                // Return HTML untuk 1 alert
                return `
                    <div class="fraud-alert">
                        <div class="fraud-alert-header">
                            <div>
                                <strong>üö® ${alert.deviceName || alert.deviceId}</strong>
                                <span class="risk-badge ${riskClass}">${alert.riskLevel}</span>
                                <span class="decision-badge ${decisionClass}">${alert.decision}</span>
                            </div>
                            <div style="font-size: 14px; color: #7f8c8d;">
                                Risk Score: <strong style="color: #e74c3c;">${alert.riskScore}%</strong>
                                | Confidence: <strong>${Math.round(alert.confidence * 100)}%</strong>
                            </div>
                        </div>
                        <div class="fraud-alert-content">
                            <div><strong>Transaction ID:</strong> ${alert.transactionId || 'N/A'}</div>
                            <div><strong>IP Address:</strong> ${alert.ipAddress || 'Unknown'}</div>

                            ${alert.reasons && alert.reasons.length > 0 ? `
                            <div class="fraud-reasons">
                                <strong>üîç Risk Factors:</strong>
                                <ul>
                                    ${alert.reasons.map(reason => `<li>${reason}</li>`).join('')}
                                </ul>
                            </div>
                            ` : ''}

                            ${alert.riskFactors ? `
                            <div style="margin-top: 10px; font-size: 12px;">
                                <strong>AI Analysis:</strong>
                                Velocity: ${Math.round(alert.riskFactors.velocityRisk * 100)}%,
                                Amount: ${Math.round(alert.riskFactors.amountRisk * 100)}%,
                                Time: ${Math.round(alert.riskFactors.timeRisk * 100)}%,
                                Device: ${Math.round(alert.riskFactors.deviceRisk * 100)}%
                            </div>
                            ` : ''}

                            <div class="fraud-timestamp">
                                üïê ${formatDate(alert.timestamp)} (${formatRelativeTime(alert.timestamp)})
                            </div>
                        </div>
                    </div>
                `;
            }).join(''); // Gabungkan semua HTML jadi string
        }

        // Load semua transaksi dari backend
        async function loadAllTransactions() {
            try {
                const limit = document.getElementById('limitInput').value || 50; // Ambil limit (default 50)
                const response = await fetch(`/api/transactions?limit=${limit}`); // Request ke backend
                
                if (response.ok) { // Jika sukses
                    const data = await response.json(); // Parse JSON
                    allTransactions = data.transactions || []; // Simpan transaksi
                    filteredTransactions = allTransactions; // Set filtered = all (belum ada filter)
                    renderTransactions(); // Render ke tabel
                    console.log(`‚úÖ Loaded ${allTransactions.length} transactions`);
                } else {
                    console.error('Failed to load transactions:', response.statusText);
                    document.getElementById('transactionsContainer').innerHTML = 
                        '<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Failed to load transactions. Make sure backend is running.</p>';
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsContainer').innerHTML = 
                    '<p style="text-align: center; color: #e74c3c; padding: 20px;">‚ùå Error: Cannot connect to backend server</p>';
            }
        }

        // Filter transaksi berdasarkan risk level (HIGH/MEDIUM/LOW/ALL)
        function filterTransactionsByRisk() {
            const riskFilter = document.getElementById('riskFilter').value; // Ambil nilai filter
            
            if (riskFilter === 'ALL') { // Jika ALL, tampilkan semua
                filteredTransactions = allTransactions;
            } else { // Jika HIGH/MEDIUM/LOW, filter sesuai risk level
                filteredTransactions = allTransactions.filter(tx => tx.fraudRiskLevel === riskFilter);
            }
            
            renderTransactions(); // Render ulang tabel
        }

        // Render tabel transaksi (mirip Prisma Studio)
        function renderTransactions() {
            const container = document.getElementById('transactionsContainer'); // Ambil container
            
            // Jika tidak ada transaksi
            if (filteredTransactions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No transactions found</p>';
                return;
            }

            // Buat HTML tabel
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Sender</th>
                                <th>Receiver</th>
                                <th>Amount</th>
                                <th>Risk Score</th>
                                <th>Risk Level</th>
                                <th>Reasons</th>
                                <th>Status</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredTransactions.map(tx => {
                                const riskScore = tx.fraudRiskScore || 0; // Score 0-100
                                const riskLevel = tx.fraudRiskLevel || 'LOW'; // HIGH/MEDIUM/LOW
                                const riskClass = `risk-${riskLevel.toLowerCase()}`; // CSS class
                                const reasons = tx.fraudReasons ? JSON.parse(tx.fraudReasons) : []; // Parse JSON reasons
                                
                                // Return HTML untuk 1 baris transaksi
                                return `
                                    <tr>
                                        <td><strong>#${tx.id}</strong></td>
                                        <td>
                                            <div><strong>${tx.sender.name}</strong></div>
                                            <div style="font-size: 12px; color: #7f8c8d;">@${tx.sender.username}</div>
                                        </td>
                                        <td>
                                            <div><strong>${tx.receiver.name}</strong></div>
                                            <div style="font-size: 12px; color: #7f8c8d;">@${tx.receiver.username}</div>
                                        </td>
                                        <td><strong>Rp ${tx.amount.toLocaleString('id-ID')}</strong></td>
                                        <td>
                                            <span class="risk-score" style="color: ${getRiskScoreColor(riskScore)};">
                                                <strong>${riskScore.toFixed(1)}</strong>
                                            </span>
                                        </td>
                                        </td>
                                        <td>
                                            <div class="fraud-reasons-mini">
                                                ${reasons.length > 0 
                                                    ? reasons.map(r => `<div>‚Ä¢ ${r}</div>`).join('') 
                                                    : '<span style="color: #27ae60;">‚úì Normal</span>'}
                                            </div>
                                        </td>
                                        <td>
                                            <span class="status-badge status-${tx.status}">${tx.status}</span>
                                        </td>
                                        <td style="font-size: 12px; color: #7f8c8d;">
                                            ${formatDate(tx.createdAt)}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
                    <strong>Statistics:</strong> 
                    Showing ${filteredTransactions.length} of ${allTransactions.length} transactions
                    ${allTransactions.length !== filteredTransactions.length 
                        ? `(filtered by ${document.getElementById('riskFilter').value})` 
                        : ''}
                </div>
            `;
            
            container.innerHTML = tableHTML; // Set HTML ke container
        }

        // Fungsi untuk warna risk score (0-100)
        function getRiskScoreColor(score) {
            if (score >= 80) return '#c0392b';  // CRITICAL - merah tua (>= 80)
            if (score >= 60) return '#e74c3c';  // HIGH - merah (60-79)
            if (score >= 40) return '#f39c12';  // MEDIUM - orange (40-59)
            return '#27ae60';                    // LOW - hijau (< 40)
        }

        // ==================== FUNGSI QUICK ACTIONS ====================
        
        // Fungsi untuk block user (ban user dari sistem)
        function showBlockUserModal() {
            const username = prompt('Masukkan username yang akan di-block:'); // Input username
            if (!username) return; // Jika cancel/kosong, hentikan
            
            const reason = prompt('Alasan block:', 'Suspicious activity'); // Input alasan
            const password = prompt('Masukkan password admin untuk konfirmasi:'); // Minta password admin
            if (password !== 'admin123') { // Validasi password
                alert('‚ùå Password salah!');
                return;
            }
            
            // Cari user berdasarkan username
            const user = allUsers.find(u => u.username === username);
            if (!user) { // Jika user tidak ditemukan
                alert('‚ùå User tidak ditemukan!');
                return;
            }
            
            // Konfirmasi sebelum block
            if (confirm(`Block user "${username}"? User tidak akan bisa melakukan transaksi.`)) {
                // Kirim request ke backend
                fetch('/api/block-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp', // Auth key
                        'user-agent': 'okhttp/4.9.0'
                    },
                    body: JSON.stringify({ userId: user.id, password })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) { // Jika sukses
                        logActivity('action', `‚úÖ Blocked user: ${username}`, '#e74c3c');
                        alert('‚úÖ User berhasil di-block!');
                        refreshAllData(); // Refresh semua data
                    } else {
                        logActivity('error', `Failed to block user: ${username}`, '#e74c3c');
                        alert('‚ùå Gagal block user: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => { // Jika error
                    console.error('Block user error:', err);
                    logActivity('error', `Error blocking user: ${username}`, '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        // Fungsi untuk unblock user (kembalikan user yang diblokir)
        function showUnblockUserModal() {
            const username = prompt('Masukkan username yang akan di-unblock:'); // Input username
            if (!username) return; // Jika cancel/kosong, hentikan
            
            const password = prompt('Masukkan password admin untuk konfirmasi:'); // Minta password admin
            if (password !== 'admin123') { // Validasi password
                alert('‚ùå Password salah!');
                return;
            }
            
            // Cari user berdasarkan username
            const user = allUsers.find(u => u.username === username);
            if (!user) { // Jika user tidak ditemukan
                alert('‚ùå User tidak ditemukan!');
                return;
            }
            
            // Cek apakah user memang sedang diblokir
            if (user.isActive) {
                alert('‚ö†Ô∏è User ini tidak sedang diblokir!');
                return;
            }
            
            // Konfirmasi sebelum unblock
            if (confirm(`Unblock user "${username}"? User akan bisa melakukan transaksi kembali.`)) {
                // Kirim request ke backend
                fetch('/api/unblock-user', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp', // Auth key
                        'user-agent': 'okhttp/4.9.0'
                    },
                    body: JSON.stringify({ userId: user.id, password })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) { // Jika sukses
                        logActivity('action', `‚úÖ Unblocked user: ${username}`, '#27ae60');
                        alert('‚úÖ User berhasil di-unblock!');
                        refreshAllData(); // Refresh semua data
                    } else {
                        logActivity('error', `Failed to unblock user: ${username}`, '#e74c3c');
                        alert('‚ùå Gagal unblock user: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => { // Jika error
                    console.error('Unblock user error:', err);
                    logActivity('error', `Error unblocking user: ${username}`, '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        // Fungsi reset balance user ke nilai tertentu
        function showResetBalanceModal() {
            const username = prompt('Masukkan username untuk reset balance:'); // Input username
            if (!username) return;
            
            const newBalance = prompt('Masukkan balance baru:', '1000000'); // Input balance baru
            if (!newBalance) return;
            
            const password = prompt('Masukkan password admin untuk konfirmasi:'); // Minta password admin
            if (password !== 'admin123') { // Validasi password
                alert('‚ùå Password salah!');
                return;
            }
            
            // Konfirmasi reset balance
            if (confirm(`Reset balance "${username}" menjadi Rp ${parseInt(newBalance).toLocaleString('id-ID')}?`)) {
                // Cari user berdasarkan username
                const user = allUsers.find(u => u.username === username);
                if (!user) { // Jika user tidak ditemukan
                    alert('‚ùå User tidak ditemukan!');
                    return;
                }
                
                // Kirim request update balance
                fetch('/api/reset-balance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    },
                    body: JSON.stringify({ userId: user.id, newBalance: parseInt(newBalance), password })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) { // Jika sukses
                        logActivity('action', `‚úÖ Reset balance: ${username} -> Rp ${parseInt(newBalance).toLocaleString('id-ID')}`, '#f39c12');
                        alert('‚úÖ Balance berhasil di-reset!');
                        refreshAllData(); // Refresh data
                    } else {
                        logActivity('error', `Failed to reset balance: ${username}`, '#e74c3c');
                        alert('‚ùå Gagal reset balance: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => { // Jika error
                    console.error('Reset balance error:', err);
                    logActivity('error', `Error resetting balance: ${username}`, '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        // Fungsi bulk top-up ke SEMUA user sekaligus
        function showBulkTopupModal() {
            const amount = prompt('Masukkan jumlah topup untuk SEMUA user:', '100000'); // Input amount
            if (!amount) return;
            
            const password = prompt('Masukkan password admin untuk konfirmasi:'); // Minta password admin
            if (password !== 'admin123') { // Validasi password
                alert('‚ùå Password salah!');
                return;
            }
            
            // Konfirmasi bulk topup
            if (confirm(`Top-up Rp ${parseInt(amount).toLocaleString('id-ID')} untuk SEMUA user (${allUsers.length} users)?`)) {
                // Kirim request bulk topup
                fetch('/api/bulk-topup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    },
                    body: JSON.stringify({ amount: parseInt(amount), password })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) { // Jika sukses
                        logActivity('action', `‚úÖ Bulk topup: Rp ${parseInt(amount).toLocaleString('id-ID')} to ${allUsers.length} users`, '#27ae60');
                        alert(`‚úÖ Bulk topup berhasil!\nAmount: Rp ${parseInt(amount).toLocaleString('id-ID')}\nUsers: ${allUsers.length}`);
                        refreshAllData(); // Refresh data
                    } else {
                        logActivity('error', 'Failed bulk topup', '#e74c3c');
                        alert('‚ùå Gagal bulk topup: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => { // Jika error
                    console.error('Bulk topup error:', err);
                    logActivity('error', 'Error bulk topup', '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        // Fungsi Clear Fraud Alerts: Hapus semua history fraud
        function clearAllFraudAlerts() {
            // Konfirmasi sebelum menghapus
            if (confirm('Clear semua fraud alerts? Ini akan menghapus history fraud detection.')) {
                // Kirim request clear alerts
                fetch('/api/clear-fraud-alerts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) { // Jika sukses
                        logActivity('action', `‚úÖ Cleared ${data.clearedCount} fraud alerts`, '#95a5a6');
                        alert(`‚úÖ ${data.clearedCount} fraud alerts cleared!`);
                        refreshAllData(); // Refresh data
                    } else {
                        logActivity('error', 'Failed to clear fraud alerts', '#e74c3c');
                        alert('‚ùå Gagal clear fraud alerts: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => { // Jika error
                    console.error('Clear fraud alerts error:', err);
                    logActivity('error', 'Error clearing fraud alerts', '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        // Refresh semua data (devices, fraud, transactions, users)
        function refreshAllData() {
            logActivity('system', 'Admin refreshed all data', '#16a085'); // Log aktivitas
            loadDevices(); // Load device
            loadFraudAlerts(); // Load fraud alerts
            loadAllTransactions(); // Load transaksi
            loadAllUsers(); // Load users
            loadNFCCards(); // Load NFC cards
        }

        // ==================== FUNGSI NFC CARD MANAGEMENT ====================
        
        // Load semua kartu NFC dari backend
        async function loadNFCCards() {
            try {
                logActivity('system', 'üîÑ Loading NFC cards...', '#3498db');
                
                const response = await fetch('/api/nfc-cards', {
                    headers: {
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        nfcCards = data.cards || [];
                        filteredNfcCards = nfcCards;
                        
                        logActivity('system', `‚úÖ Loaded ${nfcCards.length} NFC cards`, '#27ae60');
                        renderNFCCards();
                    } else {
                        console.error('Failed to load NFC cards:', data.error);
                        logActivity('error', `‚ùå Failed to load cards: ${data.error}`, '#e74c3c');
                        document.getElementById('nfcCardsList').innerHTML = 
                            '<div class="no-data">‚ùå Failed to load NFC cards: ' + (data.error || 'Unknown error') + '</div>';
                    }
                } else {
                    console.error('Failed to load NFC cards:', response.statusText);
                    logActivity('error', `‚ùå HTTP ${response.status}: ${response.statusText}`, '#e74c3c');
                    document.getElementById('nfcCardsList').innerHTML = 
                        '<div class="no-data">‚ùå Failed to load NFC cards (HTTP ' + response.status + ')</div>';
                }
            } catch (err) {
                console.error('Load NFC cards error:', err);
                logActivity('error', `‚ùå Error: ${err.message}`, '#e74c3c');
                document.getElementById('nfcCardsList').innerHTML = 
                    '<div class="no-data">‚ùå Error loading cards: ' + err.message + '</div>';
            }
        }

        // Refresh NFC cards
        function refreshCards() {
            logActivity('action', 'üîÑ Refreshing NFC cards...', '#16a085');
            loadNFCCards();
        }

        // Filter kartu berdasarkan search dan filter
        function filterCards() {
            const searchTerm = document.getElementById('cardSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('cardStatusFilter').value;
            const linkFilter = document.getElementById('cardLinkFilter').value;

            filteredNfcCards = nfcCards.filter(card => {
                // Search filter
                const matchSearch = !searchTerm || 
                    card.cardId.toLowerCase().includes(searchTerm) ||
                    (card.userId && card.user && (
                        card.user.username.toLowerCase().includes(searchTerm) ||
                        card.user.name.toLowerCase().includes(searchTerm)
                    ));

                // Status filter
                const matchStatus = !statusFilter || card.cardStatus === statusFilter;

                // Link filter
                const matchLink = !linkFilter || 
                    (linkFilter === 'linked' && card.userId) ||
                    (linkFilter === 'unlinked' && !card.userId);

                return matchSearch && matchStatus && matchLink;
            });

            logActivity('system', `üîç Filtered: ${filteredNfcCards.length} of ${nfcCards.length} cards`, '#95a5a6');
            renderNFCCards();
        }

        // Render daftar kartu NFC
        function renderNFCCards() {
            const container = document.getElementById('nfcCardsList');
            
            if (filteredNfcCards.length === 0) {
                container.innerHTML = '<div class="no-data">No NFC cards found</div>';
                return;
            }

            container.innerHTML = filteredNfcCards.map(card => {
                const statusColors = {
                    'ACTIVE': '#27ae60',
                    'BLOCKED': '#e74c3c',
                    'LOST': '#95a5a6',
                    'EXPIRED': '#f39c12'
                };
                const statusIcons = {
                    'ACTIVE': '‚úÖ',
                    'BLOCKED': 'üö´',
                    'LOST': '‚ùå',
                    'EXPIRED': '‚ö†Ô∏è'
                };
                
                const statusColor = statusColors[card.cardStatus] || '#95a5a6';
                const statusIcon = statusIcons[card.cardStatus] || '‚ùì';
                const linkedStatus = card.userId 
                    ? `üîó Linked: ${card.user?.username || 'Unknown'}` 
                    : '‚≠ï Unlinked';
                
                return `
                    <div class="device-item" style="border-left: 4px solid ${statusColor};">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <strong style="font-size: 14px;">üé¥ ${card.cardId.substring(0, 16)}...</strong>
                                <div style="font-size: 12px; color: #7f8c8d; margin-top: 3px;">
                                    ${card.cardType} ‚Ä¢ ${card.frequency}
                                </div>
                            </div>
                            <span style="background: ${statusColor}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold;">
                                ${statusIcon} ${card.cardStatus}
                            </span>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                            <div style="font-size: 13px; margin-bottom: 5px;">
                                <strong>üë§ User:</strong> ${linkedStatus}
                            </div>
                            <div style="font-size: 13px; margin-bottom: 5px;">
                                <strong>üí∞ Balance:</strong> Rp ${card.balance.toLocaleString('id-ID')}
                            </div>
                            <div style="font-size: 11px; color: #7f8c8d;">
                                Registered: ${new Date(card.createdAt).toLocaleDateString('id-ID')}
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px;">
                            ${card.userId 
                                ? `<button class="btn btn-sm" onclick="showUnlinkCardModal('${card.cardId}')" style="background: #95a5a6; color: white; padding: 6px;">
                                    üîó Unlink
                                </button>`
                                : `<button class="btn btn-sm" onclick="showLinkCardModal('${card.cardId}')" style="background: #3498db; color: white; padding: 6px;">
                                    üîó Link User
                                </button>`
                            }
                            <button class="btn btn-sm" onclick="showTopupCardModal('${card.cardId}', ${card.balance})" style="background: #27ae60; color: white; padding: 6px;">
                                üí∞ Top-up
                            </button>
                            ${card.cardStatus === 'ACTIVE' 
                                ? `<button class="btn btn-sm" onclick="blockCard('${card.cardId}')" style="background: #e74c3c; color: white; padding: 6px;">
                                    üö´ Block
                                </button>`
                                : `<button class="btn btn-sm" onclick="unblockCard('${card.cardId}')" style="background: #27ae60; color: white; padding: 6px;">
                                    ‚úÖ Unblock
                                </button>`
                            }
                            <button class="btn btn-sm" onclick="showCardHistory('${card.cardId}')" style="background: #9b59b6; color: white; padding: 6px;">
                                üìú History
                            </button>
                            <button class="btn btn-sm" onclick="deleteCard('${card.cardId}', '${card.user?.username || 'Unlinked'}')" style="background: #c0392b; color: white; padding: 6px; grid-column: span 2;">
                                üóëÔ∏è Delete Card
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Modal untuk register kartu baru
        function showRegisterCardModal() {
            const cardId = prompt('üé¥ Masukkan Card ID (UID dari NTag215):\n\nContoh: 04E1A3B2C5D6E7');
            if (!cardId) return;

            // Validasi format UID (14-20 hex characters)
            if (!/^[0-9A-Fa-f]{14,20}$/.test(cardId)) {
                alert('‚ùå Format Card ID tidak valid!\n\nCard ID harus:\n- 14-20 karakter\n- Hanya angka dan huruf A-F\n\nContoh: 04E1A3B2C5D6E7');
                return;
            }

            const initialBalance = prompt('üí∞ Balance awal (Rp):', '0');
            if (initialBalance === null) return;

            const balance = parseFloat(initialBalance);
            if (isNaN(balance) || balance < 0) {
                alert('‚ùå Balance tidak valid! Harus angka positif.');
                return;
            }

            // Kirim request register card
            fetch('/api/nfc-cards/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ 
                    cardId: cardId.toUpperCase(), 
                    balance 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `‚úÖ Registered new NFC card: ${cardId}`, '#27ae60');
                    alert(`‚úÖ Kartu berhasil didaftarkan!\n\nCard ID: ${cardId}\nBalance: Rp ${balance.toLocaleString('id-ID')}`);
                    loadNFCCards();
                } else {
                    logActivity('error', `Failed to register card: ${cardId}`, '#e74c3c');
                    alert('‚ùå Gagal register kartu: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Register card error:', err);
                logActivity('error', `Error registering card: ${cardId}`, '#e74c3c');
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Modal untuk link kartu ke user
        function showLinkCardModal(cardId) {
            const username = prompt(`üîó Link kartu ${cardId.substring(0, 12)}... ke user:\n\nMasukkan username:`);
            if (!username) return;

            fetch('/api/nfc-cards/link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ cardId, username })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `‚úÖ Linked card ${cardId} to user ${username}`, '#3498db');
                    alert(`‚úÖ Kartu berhasil dilink!\n\nCard: ${cardId}\nUser: ${username}`);
                    loadNFCCards();
                } else {
                    logActivity('error', `Failed to link card: ${data.error}`, '#e74c3c');
                    alert('‚ùå Gagal link kartu: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Link card error:', err);
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Modal untuk unlink kartu dari user
        function showUnlinkCardModal(cardId) {
            if (!confirm(`‚ö†Ô∏è Unlink kartu ${cardId.substring(0, 12)}... dari user?\n\nKartu akan tetap aktif tapi tidak terhubung ke user manapun.`)) {
                return;
            }

            fetch('/api/nfc-cards/link', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ cardId, userId: null })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `‚úÖ Unlinked card ${cardId}`, '#95a5a6');
                    alert(`‚úÖ Kartu berhasil di-unlink!`);
                    loadNFCCards();
                } else {
                    logActivity('error', `Failed to unlink card: ${data.error}`, '#e74c3c');
                    alert('‚ùå Gagal unlink kartu: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Unlink card error:', err);
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Modal untuk top-up kartu
        function showTopupCardModal(cardId, currentBalance) {
            const amount = prompt(`üí∞ Top-up kartu ${cardId.substring(0, 12)}...\n\nBalance saat ini: Rp ${currentBalance.toLocaleString('id-ID')}\n\nJumlah top-up (Rp):`);
            if (!amount) return;

            const topupAmount = parseFloat(amount);
            if (isNaN(topupAmount) || topupAmount <= 0) {
                alert('‚ùå Jumlah tidak valid! Harus angka positif.');
                return;
            }

            const password = prompt('üîí Masukkan password admin:');
            if (!password) return;

            fetch('/api/nfc-cards/topup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ 
                    cardId, 
                    amount: topupAmount,
                    adminPassword: password 
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `‚úÖ Top-up card ${cardId}: Rp ${topupAmount.toLocaleString('id-ID')}`, '#27ae60');
                    alert(`‚úÖ Top-up berhasil!\n\nCard: ${cardId}\nJumlah: Rp ${topupAmount.toLocaleString('id-ID')}\nBalance baru: Rp ${data.newBalance.toLocaleString('id-ID')}`);
                    loadNFCCards();
                } else {
                    logActivity('error', `Failed to top-up card: ${data.error}`, '#e74c3c');
                    alert('‚ùå Gagal top-up: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Top-up card error:', err);
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Block kartu
        function blockCard(cardId) {
            const reason = prompt(`üö´ Block kartu ${cardId.substring(0, 12)}...\n\nAlasan (opsional):`);
            
            fetch('/api/nfc-cards/status', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ 
                    cardId, 
                    status: 'BLOCKED',
                    reason: reason || 'Blocked by admin'
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `üö´ Blocked card ${cardId}`, '#e74c3c');
                    alert(`‚úÖ Kartu berhasil diblokir!`);
                    loadNFCCards();
                } else {
                    alert('‚ùå Gagal block kartu: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Block card error:', err);
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Unblock kartu
        function unblockCard(cardId) {
            if (!confirm(`‚úÖ Unblock kartu ${cardId.substring(0, 12)}...?\n\nKartu akan aktif kembali dan bisa digunakan untuk transaksi.`)) {
                return;
            }

            fetch('/api/nfc-cards/status', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ 
                    cardId, 
                    status: 'ACTIVE'
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `‚úÖ Unblocked card ${cardId}`, '#27ae60');
                    alert(`‚úÖ Kartu berhasil di-unblock!`);
                    loadNFCCards();
                } else {
                    alert('‚ùå Gagal unblock kartu: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Unblock card error:', err);
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Delete NFC card (Admin only)
        function deleteCard(cardId, username) {
            const cardDisplay = cardId.substring(0, 12);
            const userInfo = username !== 'Unlinked' ? `\nUser: ${username}` : '\nStatus: Unlinked';
            
            if (!confirm(`üóëÔ∏è HAPUS KARTU NFC?\n\nCard ID: ${cardDisplay}...${userInfo}\n\n‚ö†Ô∏è PERINGATAN:\n- Kartu akan dihapus PERMANEN dari sistem\n- Semua history transaksi akan DIHAPUS\n- User tidak bisa menggunakan kartu ini lagi\n- Aksi ini TIDAK BISA dibatalkan!\n\nYakin ingin menghapus?`)) {
                return;
            }

            const adminPassword = prompt('üîê Masukkan password admin untuk konfirmasi:\n\n(Password: admin123)');
            if (!adminPassword) {
                alert('‚ùå Password admin diperlukan untuk menghapus kartu');
                return;
            }

            if (adminPassword !== 'admin123') {
                alert('‚ùå Password admin salah!');
                return;
            }

            fetch(`/api/nfc-cards/${cardId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ adminPassword })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    logActivity('action', `üóëÔ∏è Deleted card ${cardId} (${username})`, '#c0392b');
                    alert(`‚úÖ Kartu berhasil dihapus!\n\nCard ID: ${cardDisplay}...\n${userInfo}\n\nSemua data dan transaksi telah dihapus dari sistem.`);
                    loadNFCCards();
                } else {
                    logActivity('error', `Failed to delete card: ${cardId}`, '#e74c3c');
                    alert('‚ùå Gagal menghapus kartu: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Delete card error:', err);
                logActivity('error', `Error deleting card: ${cardId}`, '#e74c3c');
                alert('‚ùå Error: ' + err.message);
            });
        }

        // Show card transaction history
        async function showCardHistory(cardId) {
            try {
                const response = await fetch(`/api/nfc-cards/transactions/${cardId}`, {
                    headers: {
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const transactions = data.transactions || [];
                    
                    if (transactions.length === 0) {
                        alert(`üìú History Kartu ${cardId.substring(0, 12)}...\n\nBelum ada transaksi.`);
                        return;
                    }

                    let historyText = `üìú History Kartu ${cardId.substring(0, 12)}...\n\n`;
                    historyText += `Total transaksi: ${transactions.length}\n\n`;
                    
                    transactions.slice(0, 10).forEach((tx, index) => {
                        const date = new Date(tx.timestamp).toLocaleString('id-ID');
                        historyText += `${index + 1}. ${tx.transactionType}\n`;
                        historyText += `   Amount: Rp ${tx.amount.toLocaleString('id-ID')}\n`;
                        historyText += `   Balance: Rp ${tx.balanceAfter.toLocaleString('id-ID')}\n`;
                        historyText += `   ${date}\n\n`;
                    });

                    if (transactions.length > 10) {
                        historyText += `... dan ${transactions.length - 10} transaksi lainnya`;
                    }

                    alert(historyText);
                } else {
                    alert('‚ùå Gagal load history transaksi');
                }
            } catch (err) {
                console.error('Load card history error:', err);
                alert('‚ùå Error: ' + err.message);
            }
        }

        // Fungsi untuk add transaksi manual (belum dibuat)
        function showAddTransactionModal() {
            alert('‚ö†Ô∏è Fitur add transaction manual akan ditambahkan.\n\nFitur ini akan memungkinkan admin untuk:\n- Create transaksi manual\n- Edit transaksi existing\n- Delete transaksi');
            // TODO: Create modal for adding transaction
        }

        // Fungsi untuk tambah user baru
        function showAddUserModal() {
            const username = prompt('Username user baru:'); // Input username
            if (!username) return;
            
            const name = prompt('Nama lengkap:'); // Input nama
            if (!name) return;
            
            const password = prompt('Password:', 'password123'); // Input password
            if (!password) return;
            
            const balance = prompt('Balance awal:', '1000000'); // Input balance awal
            if (!balance) return;
            
            // Kirim request create user
            fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-app-key': 'NFC2025SecureApp',
                    'user-agent': 'okhttp/4.9.0'
                },
                body: JSON.stringify({ username, name, password, balance: parseInt(balance) })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) { // Jika sukses
                    logActivity('action', `‚úÖ Added new user: ${username}`, '#27ae60');
                    alert(`‚úÖ User berhasil ditambahkan!\nUsername: ${username}\nBalance: Rp ${parseInt(balance).toLocaleString('id-ID')}`);
                    refreshAllData(); // Refresh data
                } else {
                    logActivity('error', `Failed to add user: ${username}`, '#e74c3c');
                    alert('‚ùå Gagal add user: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(err => { // Jika error
                console.error('Add user error:', err);
                logActivity('error', `Error adding user: ${username}`, '#e74c3c');
                alert('‚ùå Error: ' + err.message);
            });
        }

        // ==================== FUNGSI USER MANAGEMENT ====================
        
        // Load semua user dari semua device
        async function loadAllUsers() {
            try {
                // LANGSUNG AMBIL DARI API BACKEND
                const response = await fetch('/api/users');
                if (response.ok) {
                    const data = await response.json();
                    const newUsers = data.users || [];
                    
                    // Deteksi user baru
                    if (newUsers.length > allUsers.length) {
                        const newCount = newUsers.length - allUsers.length;
                        logActivity('user', `üë§ ${newCount} user baru terdaftar!`, '#9b59b6');
                        
                        // Tampilkan notifikasi untuk setiap user baru
                        const existingIds = allUsers.map(u => u.id);
                        const reallyNewUsers = newUsers.filter(u => !existingIds.includes(u.id));
                        reallyNewUsers.forEach(user => {
                            logActivity('user', `üë§ User baru: ${user.username} (${user.name})`, '#9b59b6');
                        });
                    }
                    
                    allUsers = newUsers;
                    renderUserList(); // Render daftar user
                    updateStats(); // UPDATE STATISTIK setelah load users
                    logActivity('system', `‚úÖ Loaded ${allUsers.length} users from backend database`, '#27ae60');
                } else {
                    // FALLBACK: Extract users dari devices jika API gagal
                    allUsers = [];
                    devices.forEach(device => {
                        if (device.users) { // Jika device punya users
                            device.users.forEach(user => {
                                // Cek duplikat berdasarkan ID
                                if (!allUsers.find(u => u.id === user.id)) {
                                    allUsers.push({
                                        ...user, // Copy semua property user
                                        deviceId: device.deviceId, // Tambah info device
                                        deviceName: device.deviceName
                                    });
                                }
                            });
                        }
                    });
                    renderUserList(); // Render daftar user
                    updateStats(); // UPDATE STATISTIK
                    logActivity('warning', `‚ö†Ô∏è Backend API failed, loaded ${allUsers.length} users from device cache`, '#f39c12');
                }
            } catch (error) {
                console.error('Error loading users:', error);
                logActivity('error', '‚ùå Failed to load users from backend', '#e74c3c');
                
                // FALLBACK: Extract users dari devices
                allUsers = [];
                devices.forEach(device => {
                    if (device.users) { // Jika device punya users
                        device.users.forEach(user => {
                            // Cek duplikat berdasarkan ID
                            if (!allUsers.find(u => u.id === user.id)) {
                                allUsers.push({
                                    ...user, // Copy semua property user
                                    deviceId: device.deviceId, // Tambah info device
                                    deviceName: device.deviceName
                                });
                            }
                        });
                    }
                });
                renderUserList();
                updateStats(); // UPDATE STATISTIK bahkan saat error
            }
        }

        // Render tabel daftar user
        function renderUserList() {
            const container = document.getElementById('userListContainer'); // Ambil container
            
            // Jika tidak ada user
            if (allUsers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No users found</p>';
                return;
            }

            // Buat HTML tabel
            const tableHTML = `
                <div style="overflow-x: auto;">
                    <table class="transactions-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Name</th>
                                <th>Balance</th>
                                <th>Device</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allUsers.map(user => `
                                <tr>
                                    <td><strong>#${user.id}</strong></td>
                                    <td><strong>@${user.username}</strong></td>
                                    <td>${user.name}</td>
                                    <td><strong>${formatCurrency(user.balance)}</strong></td>
                                    <td style="font-size: 12px; color: #7f8c8d;">${user.deviceName || user.deviceId}</td>
                                    <td>
                                        <button class="btn-sm" onclick="editUser(${user.id})" style="background: #3498db; color: white; margin: 2px;">Edit</button>
                                        <button class="btn-sm" onclick="deleteUser(${user.id}, '${user.username}')" style="background: #e74c3c; color: white; margin: 2px;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML; // Set HTML ke container
        }

        // Filter user list berdasarkan input search
        function filterUserList() {
            const search = document.getElementById('searchUserList').value.toLowerCase(); // Ambil input search
            // Filter user berdasarkan username atau name
            const filtered = allUsers.filter(user => 
                user.username.toLowerCase().includes(search) ||
                user.name.toLowerCase().includes(search)
            );
            
            // Re-render dengan user yang sudah difilter
            const originalUsers = allUsers; // Simpan data asli
            allUsers = filtered; // Ganti dengan data filter
            renderUserList(); // Render ulang
            allUsers = originalUsers; // Restore data asli
        }

        // Edit user (ubah balance)
        function editUser(userId) {
            const user = allUsers.find(u => u.id === userId); // Cari user berdasarkan ID
            if (!user) return;
            
            const newBalance = prompt(`Edit balance untuk ${user.username}:`, user.balance); // Input balance baru
            if (!newBalance) return;
            
            if (confirm(`Update balance "${user.username}" menjadi Rp ${parseInt(newBalance).toLocaleString('id-ID')}?`)) {
                fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    },
                    body: JSON.stringify({ balance: parseInt(newBalance) })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        logActivity('action', `‚úÖ Edited user: ${user.username} balance -> Rp ${parseInt(newBalance).toLocaleString('id-ID')}`, '#f39c12');
                        alert('‚úÖ User balance berhasil di-update!');
                        refreshAllData();
                    } else {
                        logActivity('error', `Failed to edit user: ${user.username}`, '#e74c3c');
                        alert('‚ùå Gagal edit user: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Edit user error:', err);
                    logActivity('error', `Error editing user: ${user.username}`, '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        function deleteUser(userId, username) {
            if (confirm(`Delete user "${username}"? Ini akan menghapus user dan semua transaksinya!`)) {
                fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-app-key': 'NFC2025SecureApp',
                        'user-agent': 'okhttp/4.9.0'
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success || data.message) {
                        logActivity('action', `‚úÖ Deleted user: ${username}`, '#e74c3c');
                        alert('‚úÖ User berhasil dihapus!');
                        refreshAllData();
                    } else {
                        logActivity('error', `Failed to delete user: ${username}`, '#e74c3c');
                        alert('‚ùå Gagal delete user: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    console.error('Delete user error:', err);
                    logActivity('error', `Error deleting user: ${username}`, '#e74c3c');
                    alert('‚ùå Error: ' + err.message);
                });
            }
        }

        // =================================================================
        // ENHANCED LOAD FUNCTIONS WITH ACTIVITY LOGGING
        // =================================================================
        
        const originalLoadDevices = loadDevices;
        loadDevices = async function() {
            await originalLoadDevices();
            if (devices.length > 0) {
                logActivity('device', `${devices.length} devices connected`, '#3498db');
            }
            loadAllUsers();
        };

        const originalLoadFraudAlerts = loadFraudAlerts;
        loadFraudAlerts = async function() {
            await originalLoadFraudAlerts();
            if (fraudAlerts.length > 0) {
                logActivity('fraud', `${fraudAlerts.length} fraud alerts detected`, '#e74c3c');
            }
        };

        const originalLoadAllTransactions = loadAllTransactions;
        loadAllTransactions = async function() {
            await originalLoadAllTransactions();
            if (allTransactions.length > 0) {
                logActivity('transaction', `${allTransactions.length} transactions loaded`, '#2ecc71');
            }
        };

        // Initial load
        console.log('üöÄ Starting initial data load...');
        loadDevices();
        loadFraudAlerts();
        loadAllTransactions();
        loadAllUsers(); // Load users saat startup
        console.log('üé¥ Loading NFC cards...');
        loadNFCCards(); // Load NFC cards saat startup
        
        // ==================== INIT AUTO REFRESH ====================
        // Aktivkan auto refresh by default untuk monitoring real-time
        setTimeout(() => {
            toggleAutoRefresh(); // Aktifkan auto refresh setelah initial load
            logActivity('system', 'üîÑ Auto refresh activated - Dashboard monitoring started', '#27ae60');
        }, 2000);
        
        // ==================== HP CONNECTION MONITOR ====================
        // Monitor koneksi HP secara real-time
        let lastDeviceCount = 0;
        let lastUserCount = 0;
        
        function checkPhoneConnection() {
            const currentDeviceCount = devices.length;
            const currentUserCount = allUsers.length;
            
            // Deteksi HP baru terkoneksi
            if (currentDeviceCount > lastDeviceCount) {
                const newDevices = currentDeviceCount - lastDeviceCount;
                logActivity('connection', `üì± ${newDevices} HP baru terkoneksi!`, '#3498db');
                showNotification(`üì± HP Terkoneksi`, `${newDevices} perangkat Android terhubung ke sistem`);
            }
            
            // Deteksi user baru
            if (currentUserCount > lastUserCount) {
                const newUsers = currentUserCount - lastUserCount;
                logActivity('user', `üë§ ${newUsers} user baru terdaftar!`, '#9b59b6');
                showNotification(`üë§ User Baru`, `${newUsers} user baru bergabung ke sistem`);
            }
            
            // Update last counts
            lastDeviceCount = currentDeviceCount;
            lastUserCount = currentUserCount;
        }
        
        // Browser notification function
        function showNotification(title, message) {
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    new Notification(title, {
                        body: message,
                        icon: 'üîî',
                        badge: 'üì±'
                    });
                } else if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification(title, {
                                body: message,
                                icon: 'üîî',
                                badge: 'üì±'
                            });
                        }
                    });
                }
            }
        }
        
        // Check phone connection setiap kali data di-refresh
        setInterval(checkPhoneConnection, 5000); // Check every 5 seconds
        
        logActivity('system', '‚úÖ Dashboard initialized - Ready for monitoring', '#2ecc71');
    </script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background-color: #2196F3;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #2196F3;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .section {
            background: white;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            font-weight: bold;
            color: #333;
        }

        .section-content {
            padding: 20px;
        }

        .device-grid {
            display: grid;
            gap: 15px;
        }

        .device-item {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }

        .device-header {
            display: flex;
            justify-content: space-between; /* perbaikan dari between */
            align-items: center;
            margin-bottom: 10px;
        }

        .device-id {
            font-weight: bold;
            color: #333;
        }

        .device-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-online {
            background: #4CAF50;
            color: white;
        }

        .status-offline {
            background: #f44336;
            color: white;
        }

        .device-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-value {
            font-weight: bold;
            color: #333;
        }

        .balance-form {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .balance-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-primary:hover {
            background: #1976D2;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 40px 20px;
            font-style: italic;
        }

        .fraud-alert {
            border: 1px solid #e74c3c;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #fff;
            box-shadow: 0 2px 4px rgba(231, 76, 60, 0.1);
        }

        .fraud-alert-header {
            padding: 15px;
            border-bottom: 1px solid #fadbd8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .fraud-alert-content {
            padding: 15px;
        }

        .risk-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .risk-critical {
            background: #e74c3c;
            color: white;
        }

        .risk-high {
            background: #e67e22;
            color: white;
        }

        .risk-medium {
            background: #f39c12;
            color: white;
        }

        .risk-low {
            background: #27ae60;
            color: white;
        }

        .decision-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .decision-block {
            background: #c0392b;
            color: white;
        }

        .decision-review {
            background: #e67e22;
            color: white;
        }

        .decision-allow {
            background: #27ae60;
            color: white;
        }

        .fraud-reasons {
            margin-top: 10px;
            padding: 10px;
            background: #ffeaa7;
            border-radius: 4px;
            border-left: 4px solid #fdcb6e;
        }

        .fraud-reasons ul {
            margin: 0;
            padding-left: 20px;
        }

        .fraud-timestamp {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 10px;
        }

        /* Transaction Table Styles (Like Prisma Studio) */
        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        .transactions-table th {
            background: #2c3e50;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .transactions-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .transactions-table tr:hover {
            background: #f8f9fa;
        }

        .risk-score {
            font-size: 16px;
            font-weight: bold;
        }

        .fraud-reasons-mini {
            font-size: 12px;
            max-width: 250px;
        }

        .fraud-reasons-mini > div {
            margin: 2px 0;
            color: #e74c3c;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-completed {
            background: #27ae60;
            color: white;
        }

        .status-pending {
            background: #f39c12;
            color: white;
        }

        .status-failed {
            background: #e74c3c;
            color: white;
        }

        @media (max-width: 768px) {
            .device-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .device-info {
                grid-template-columns: 1fr 1fr;
            }

            .balance-form {
                flex-direction: column;
                align-items: stretch;
            }

            .controls {
                flex-direction: column;
            }

            .fraud-alert-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .transactions-table {
                font-size: 12px;
            }

            .transactions-table th,
            .transactions-table td {
                padding: 8px 4px;
            }
        }

        /* Button small for table actions */
        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-sm:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        /* Action buttons styling */
        .action-btn {
            padding: 15px 20px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .action-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Info boxes styling */
        .info-box {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .info-box ul {
            margin: 8px 0 0 20px;
        }

        .info-box ul li {
            margin: 4px 0;
        }

        /* Scrollbar styling for activity log */
        #activityLog::-webkit-scrollbar {
            width: 8px;
        }

        #activityLog::-webkit-scrollbar-track {
            background: #34495e;
            border-radius: 4px;
        }

        #activityLog::-webkit-scrollbar-thumb {
            background: #7f8c8d;
            border-radius: 4px;
        }

        #activityLog::-webkit-scrollbar-thumb:hover {
            background: #95a5a6;
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Tooltip styling */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 12px;
            background: #2c3e50;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }

        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #2c3e50;
            z-index: 1000;
        }

        /* Badge animations */
        .risk-badge, .decision-badge, .status-badge {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Card hover effects */
        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Section animations */
        .section {
            animation: slideIn 0.4s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Button ripple effect */
        .btn, .action-btn {
            position: relative;
            overflow: hidden;
        }

        .btn::after, .action-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::after, .action-btn:active::after {
            width: 300px;
            height: 300px;
        }

        /* Table row highlight */
        .transactions-table tbody tr {
            transition: background-color 0.2s ease;
        }

        .transactions-table tbody tr:hover {
            background: #e8f4f8;
            cursor: pointer;
        }

        /* Device item animations */
        .device-item {
            transition: all 0.3s ease;
        }

        .device-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* Fraud alert pulse animation */
        .fraud-alert {
            animation: alertPulse 2s ease-in-out infinite;
        }

        @keyframes alertPulse {
            0%, 100% {
                box-shadow: 0 2px 4px rgba(231, 76, 60, 0.1);
            }
            50% {
                box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            }
        }

        /* Input focus effects */
        input[type="text"],
        input[type="number"],
        select,
        .balance-input {
            transition: all 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        .balance-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Status indicator animations */
        .status-online, .status-offline {
            animation: statusBlink 1s ease-in-out infinite;
        }

        @keyframes statusBlink {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* Print styles */
        @media print {
            .controls,
            .btn,
            .action-btn,
            button {
                display: none;
            }

            .section {
                page-break-inside: avoid;
            }

            body {
                background: white;
            }

            .stat-card,
            .section,
            .device-item {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* Dark mode support (optional) */
        @media (prefers-color-scheme: dark) {
            /* Uncomment jika ingin dark mode auto
            body {
                background-color: #1a1a1a;
                color: #f5f5f5;
            }

            .section,
            .stat-card,
            .device-item {
                background: #2c2c2c;
                color: #f5f5f5;
            }

            .transactions-table th {
                background: #1a1a1a;
            }

            .transactions-table td {
                border-bottom-color: #3c3c3c;
            }
            */
        }

        /* Accessibility improvements */
        *:focus {
            outline: 2px solid #3498db;
            outline-offset: 2px;
        }

        button:focus,
        .btn:focus,
        .action-btn:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }

        /* Skip to main content link */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #3498db;
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Screen reader only content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom selection color */
        ::selection {
            background: #3498db;
            color: white;
        }

        ::-moz-selection {
            background: #3498db;
            color: white;
        }
    </style>
</body>
</html>
